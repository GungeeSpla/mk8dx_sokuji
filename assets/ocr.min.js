"use strict";console.log("ocr.js is ver.0.2.3");const canvas1=createCanvas(!1,1280,720),canvas2=createCanvas(!1,460,50),canvas3=createCanvas(!1,460,600),canvas4=createCanvas(!1,108,600),canvas5=createCanvas(!1,100,100),canvas6=createCanvas(!1,66,623);function scanGameScreen(e,t){let r=function(e,t,r,a,n,i,o){let l=function(e,t){h.data[e+0]=t,h.data[e+1]=t,h.data[e+2]=t},c=function(e,t,r){let a=4*(e+t*r),n=h.data[a+0],i=h.data[a+1],o=h.data[a+2];return n>180&&i>180&&o<100?1:0},s=t.width,$=t.height;t.ctx.drawImage(e,a,n,i,o,0,0,s,$);let h=t.ctx.getImageData(0,0,s,$),u=function(e,t){let r=0,a,n;for(n=0,n=0;n<t;n++)r+=c(a,n,e);for(a=0,n=0;a<e;a++)r+=c(a,n,e);return r>100}(s,$),d,g,p,v,m,f,w;for(g=0;g<$;g++)for(d=0;d<s;d++)p=4*(d+g*s),v=h.data[p+0],m=h.data[p+1],f=h.data[p+2],u?((w=550-v-m-f)<120&&(v=255),l(p,v)):l(p,v=(w=765-v-m-f)>500?255:255-(v+m+f)/3);return h};console.log("- recognizing 1st - 12th player names"),canvas1.ctx.burnImage(e,0,0,canvas1.width,canvas1.height);let a,n,i,o,l=[];for(a=0;a<12;a++){canvas2.width=canvas3.width,i=(o=r(canvas1,canvas2,a,678,62+52*a,230,25)).width*o.height;let c=new Uint8Array(new ArrayBuffer(i));for(n=0;n<i;n++)c[n]=o.data[4*n];l.push(c),canvas3.ctx.putImageData(o,0,50*a)}for(a=0;a<12;a++)canvas2.width=canvas4.width,o=r(canvas1,canvas2,a,1164,65+52*a,54,25),canvas4.ctx.putImageData(o,0,50*a);let s=[];for(a=0;a<12;a++)s.push({top:50*a,left:0,width:460,height:50});"function"==typeof t&&t(l)}function getTeamRankArray(e,t){let r=function(e,t){let r=0;for(let a=0;a<e.length;a++)r-=Math.abs(e[a]-t[a]);return r},a=[];e.forEach((e,n)=>{let i=[];t.forEach(t=>{let a=r(e,t.name);i.push({score:a,team:t.teamName})}),i.sort((e,t)=>e.score>t.score?-1:1),a.push({name:e,rank:n+1,topTeam:i[0].team,topScore:i[0].score,candidates:i})}),a.sort((e,t)=>e.topScore>t.topScore?-1:1);let n=[];t.forEach(e=>n.push(e.teamName)),a.forEach(e=>{for(let t=0;t<e.candidates.length;t++){let r=e.candidates[t],a=n.indexOf(r.team);if(a>=0){e.topTeam=r.team,e.topScore=r.score,n.splice(a,1);break}}}),a.sort((e,t)=>e.rank<t.rank?-1:1);let i=[];return a.forEach(e=>i.push(e.topTeam)),i}function checkScanable(e,t){"string"==typeof e&&(e=document.querySelector(e)),console.log("- checking necessity of trimming");let r=canvas5,a=e.naturalWidth,n=e.naturalHeight;r.width=a,r.height=n,r.ctx.globalAlpha="1",r.ctx.globalCompositeOperation="source-over",r.ctx.drawImage(e,0,0);let i=a/1280,o={},l={x:555,y:50,w:66,h:623};canvas6.width=l.w,canvas6.height=l.h,Object.keys(l).forEach(e=>{o[e]=l[e],l[e]=Math.round(l[e]*i)}),canvas6.ctx.fillStyle="#000",canvas6.ctx.clearRect(0,0,o.w,o.h),canvas6.ctx.burnImage(e,l.x,l.y,l.w,l.h,0,0,o.w,o.h);let c=Math.round(o.h/12),s=!1,$,h,u,d,g,p,v,m,f,w,y,_,x,b,I,S,k,E,L;for($=0;$<12;$++){let P=canvas6.ctx.getImageData(0,$*c,o.w,c);for(_=!1,L=o.w,!s&&(d=4*(4+25*L),g=P.data[d+0],p=P.data[d+1],v=P.data[d+2],y=100,(m=510-g-p+v)<y&&(_=!0,s=!0)),u=0;u<n;u++)for(h=0;h<L;h++)d=4*(h+u*L),g=P.data[d+0],f=g+(p=P.data[d+1])+(v=P.data[d+2]),w=765-g-p-v,g=p=_?f<y?v=255:v=0:w<y?v=255:f<y?v=0:v=255,P.data[d+0]=g,P.data[d+1]=p,P.data[d+2]=v;canvas6.ctx.putImageData(P,0,$*c)}for($=0;$<12;$++)canvas6.ctx.fillRect(0,$*c-5,o.w,6);let B=document.querySelector("#rank-image-mono"),C=canvas6.ctx.getImageData(0,0,o.w,o.h);canvas6.ctx.drawImage(B,0,0);let T=canvas6.ctx.getImageData(0,0,o.w,o.h);for(u=0,m=0,L=o.w;u<n;u++)for(h=0;h<L;h++)d=4*(h+u*L),x=C.data[d+0],b=C.data[d+1],I=C.data[d+2],S=T.data[d+0],k=T.data[d+1],E=T.data[d+2],x===S&&b===k&&I===E||m++;let q=m<2e3;return q?console.log("- no need to trim"):console.log("- please trim"),{isScanable:q,canvas:r}}function trimGameScreen(e,t,r){if("string"==typeof e){let a=new Image;a.src=e,e=a}let{isScanable:n,canvas:i}=checkScanable(e);n?"function"==typeof t&&t(i,!1):trimGameScreenByRect(e,t,r)}const getWindowWidth=()=>window.innerWidth||!!document.body&&document.body.clientWidth||document.documentElement.clientWidth,getWindowHeight=()=>window.innerHeight||!!document.body&&document.body.clientHeight||document.documentElement.clientHeight;let $viewerWrapper,$viewerClose,$viewerInner,$viewerImage,$viewerRank,$viewerRankPs,$viewerButton,$viewerButtonRB,$viewerButtonMake,$viewerButtonRead,$viewerButtonClose,$viewerButtonPs,footerNotice,noticeTimer;function makeZoomImage(){$viewerWrapper=document.querySelector("#image-viewer-wrapper"),$viewerInner=document.querySelector("#image-viewer-inner"),$viewerImage=document.querySelector("#image-viewer-image"),$viewerRank=document.querySelector("#image-viewer-rank"),$viewerRankPs=document.querySelectorAll("#image-viewer-rank p"),$viewerButton=document.querySelector("#image-viewer-button"),$viewerButtonRB=document.querySelector("#image-viewer-button-rb"),$viewerButtonMake=document.querySelector("#image-viewer-button-make"),$viewerButtonRead=document.querySelector("#image-viewer-button-read"),$viewerButtonClose=document.querySelector("#image-viewer-button-close"),$viewerButtonPs=document.querySelectorAll("#image-viewer-button p"),footerNotice=document.querySelector("#footer-notice");let e=()=>{$viewerWrapper.style.setProperty("opacity","0"),setTimeout(()=>{$viewerWrapper.style.setProperty("display","none")},300)};$viewerButtonClose.addEventListener(mousedownEvent,e),$viewerButtonRead.addEventListener(mousedownEvent,()=>{let t;scanTeamData(parseInt($viewerImage.getAttribute("race")))&&e()}),$viewerButtonMake.addEventListener(mousedownEvent,()=>{let t;makeSampleTeamData(parseInt($viewerImage.getAttribute("race")))&&e()}),$viewerButtonRB.addEventListener(mousedownEvent,()=>{let t=document.querySelector(".fix-image-rb");t&&t.parentNode.removeChild(t);let r=new Image;r.src=$viewerImage.src,r.classList.add("fix-image-rb"),r.addEventListener(mousedownEvent,e=>(r.parentNode.removeChild(r),e.stopPropagation(),!1)),document.body.appendChild(r),e(),notifyFooter("クリックで消去できます。")})}function setEventZoomImage(e,t){"string"==typeof e&&(e=document.querySelector(e)),e.style.cursor="pointer",e.addEventListener(mousedownEvent,()=>{if(void 0!==t){$viewerImage.setAttribute("race",t);let r=inputRankData[t-1];document.querySelectorAll("#image-viewer-rank p").forEach((e,t)=>{e.innerText="",e.classList.add("team--1"),e.classList.remove("team-0"),e.classList.remove("team-1"),e.classList.remove("team-2"),e.classList.remove("team-3"),e.classList.remove("team-4"),e.classList.remove("team-5"),e.classList.remove("team-6"),"-1"!==r[t]&&(e.classList.remove("team--1"),e.classList.add(`team-${r[t]}`),e.innerText=teamNames[r[t]])})}let a=window.isOverlay?800:getWindowWidth(),n=window.isOverlay?800:getWindowHeight(),i=.8*a,o=.8*n,l=e.naturalWidth,c=e.naturalHeight,s=l/c,$,h,u,d;i/o>s?$=(h=o)*s:h=($=i)/s,u=(a-$)/2,d=(n-1.1*h)/2,$viewerInner.style.setProperty("width",`${$}px`),$viewerInner.style.setProperty("height",`${h}px`),$viewerInner.style.setProperty("top",`${d}px`),$viewerInner.style.setProperty("left",`${u}px`),$viewerButton.style.setProperty("top",`${h}px`),$viewerButton.style.setProperty("width",`${$}px`),$viewerButtonPs.forEach(e=>{e.style.setProperty("height",`${.11*h}px`),e.style.setProperty("line-height",`${.11*h}px`),e.style.setProperty("font-size",`${.05*h}px`)}),$viewerRankPs.forEach(e=>{e.style.setProperty("line-height",`${.05*h}px`),e.style.setProperty("font-size",`${.03*h}px`)}),$viewerImage.src=e.src,$viewerWrapper.style.setProperty("display","block"),setTimeout(()=>{$viewerWrapper.style.setProperty("opacity","1")},1)})}function notifyFooter(e){let t=document.createElement("p");t.textContent=e,t.style.setProperty("transition","none"),t.style.setProperty("display","block"),footerNotice.innerHTML="",footerNotice.appendChild(t),clearTimeout(noticeTimer),noticeTimer=setTimeout(()=>{clearTimeout(noticeTimer),noticeTimer=setTimeout(()=>{t.style.setProperty("transition",""),t.style.setProperty("opacity","0"),clearTimeout(noticeTimer),noticeTimer=setTimeout(()=>{footerNotice.innerHTML=""},600)},5e3)},1)}function setEventPasteImage(e,t){"string"==typeof e&&(e=document.querySelector(e));let r="<span>paste</span>";e.setAttribute("contenteditable","true"),e.innerHTML=r,e.addEventListener("paste",function(e){let a=this;if(!e.clipboardData||!e.clipboardData.types||1!=e.clipboardData.types.length||"Files"!=e.clipboardData.types[0])return!0;let n=e.clipboardData.items[0].getAsFile(),i=new FileReader;return i.onload=function(e){let r=e.target.result,n=document.createElement("img");n.onload=function(e){n.onload=null,t&&t(this,a)},n.setAttribute("src",r)},i.readAsDataURL(n),this.innerHTML=r,!1}),e.addEventListener("input",function(e){let a=document.createElement("div");a.innerHTML=this.innerHTML;let n=a.querySelector("img");n?t&&t(n,this):notifyFooter("画像データではありません。"),this.innerHTML=r})}function createTitledImage(e,t){let r=document.createElement("div");r.classList.add("titled-image-wrapper");let a=document.createElement("p");return a.textContent=t,r.appendChild(e),r.appendChild(a),r}function createCanvas(e,t,r){let a=document.createElement("canvas");return a.width=t,a.height=r,a.ctx=a.getContext("2d"),a.ctx.clear=function(){a.ctx.clearRect(0,0,a.width,a.height)},a.ctx.myDrawImage=function(e){a.ctx.drawImage(e,0,0,a.width,a.height)},a.ctx.burnImage=function(e){let t=arguments;function r(e,r){void 0!==e&&(a.ctx.globalCompositeOperation=e),void 0===r&&(r=1);for(let n=0;n<r;n++)a.ctx.drawImage.apply(a.ctx,t)}r("source-over",1),r("multiply",5),r("overlay",5),r("source-over",0)},a.fill=function(e){this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.width,this.height)},a.init=function(e,t,r){this.width=e,this.height=t,this.ctx.globalAlpha="1",this.ctx.globalCompositeOperation="source-over",this.ctx.clear(),this.ctx.drawImage(r,0,0,e,t)},e&&document.body.appendChild(a),a}function createArray(e,t){let r=[];for(let a=0;a<e;a++)r[a]=t;return r}function createInt16Array(e){let t=new ArrayBuffer(e<<1),r=new Int16Array(t);for(let a=0;a<r.length;a++)r[a]=0;return r}function getRatio(e,t){let r=e>t,a=r?e:t,n=r?t:e;return 64*n<a?64:a/n}function trimGameScreenByRect(e,t,r){"string"==typeof e&&(e=document.querySelector(e)),console.log("- trimming the game screen");let a=canvas5,n=e.naturalWidth,i=e.naturalHeight;console.log(`- the image is (w, h) = (${n}, ${i})`),a.init(n,i,e);let o=function(e){let t,r,n,i,o,l,c,s,$,h,u,d,g=function(){for(let e=0;e<2;e++)if(r>i[e]){for(let a=e;a+1<2;a++)i[a+1]=i[a],n[a+1]=n[a];i[e]=r,n[e]=t;break}r=0,t=s+1},p="vertical"===e,v=a.width,m=a.height;p?(o=v,l=m):(o=m,l=v);let f=a.ctx.getImageData(0,0,v,m),w=createInt16Array(2*o*2);for(c=0;c<o;c++){let y=-1,_=-1,x=-1;for(t=0,r=0,n=createArray(2,0),i=createArray(2,0),s=0;s<l;s++)$=p?(c+s*v)*4:(s+c*v)*4,h=f.data[$+0],u=f.data[$+1],d=f.data[$+2],h===y&&u===_&&d===x?r++:(r&&g(),y=h,_=u,x=d);g();for(let b=0;b<2;b++)w[0+(2*c+b)*2]=n[b],w[1+(2*c+b)*2]=i[b]}return w},l=function(e,t,r){let n,i,o=a.width,l=a.height;"vertical"===e?(n=o,i=l):(n=l,i=o);let c=[-1],s=[-1],$=[],h,u=t.length/4;for(let d=0;d<u;d++){let g=0;for(let p=0;p<2;p++)g+=t[1+(2*d+p)*2];d>0&&Math.abs(g-h)>r&&(g<h?(c.push(d-1),s.push(d-1)):(c.push(d),$.push(d))),h=g}return c.push(n+1),$.push(n+1),[c,s,$]},c=o("horizontal"),s=o("vertical"),[$,h,u]=l("vertical",s,Math.floor(15*n/100)),[d,g,p]=l("horizontal",c,Math.floor(15*i/100)),v=function(e,t){let r=[],a=Math.floor(.05*n),o=Math.floor(.05*i);for(let l=0;l+1<e.length;l++){let c=e[l+0]+1,s=e[l+1],$=s-c;if($>a)for(let h=0;h+1<t.length;h++){let u=d[h+0]+1,g=d[h+1],p=g-u;p>o&&r.push({x:c,y:u,w:$,h:p,s:$*p})}}return r.sort((e,t)=>e.s>t.s?-1:1),r}($,d);!function(e){let t=Math.min(e.length,3),r=[];for(let a=0;a<e.length;a++){let n=e[a],i=!0;for(let o=0;o<r.length;o++){let l=r[o],c=l.x===n.x&&l.w===n.w,s=l.y===n.y&&l.h===n.h;if(c||s){i=!1;break}}if(i&&r.push(n),r.length>=t)break}}(v);let m=function(e,t,r,n,i){let o=function(e,t,r,a,n){for(let i=0;i<a.length;i++){let o=a[i]+1;for(let l=0;l<n.length;l++){let c=n[l],h=c-o,u;(u=e?{x:o,y:r.y,w:h,h:r.h,s:h*r.h}:{x:r.x,y:o,w:r.w,h:h,s:h*r.w}).w>s&&u.h>$&&u.w>u.h&&u.w<2*u.h&&t.push(u)}}},l=a.width,c=a.height,s=Math.floor(.05*l),$=Math.floor(.05*c),h=[];for(let u=0;u<e.length;u++){let d=e[u];h.push(d),o(!0,h,d,t,r),o(!1,h,d,n,i)}return!function(e){let t=9/16;e.forEach(e=>{let r=e.h/e.w,a=Math.abs(t-r);r<t&&(a*=2),e.score=e.w/l-100*a})}(h),!function(e){e.sort((e,t)=>e.score>t.score?-1:1)}(h),h}(v,h,u,g,p),f=m[0];f?(canvas6.width=1280,canvas6.height=720,canvas6.ctx.drawImage(e,f.x,f.y,f.w,f.h,0,0,1280,720),console.log("- trimed the game screen"),console.log(`- the game screen is (x, y, w, h) = (${f.x}, ${f.y}, ${f.w}, ${f.h})`),"function"==typeof t&&t(canvas6,!0)):(console.log("- sorry, trimming failed"),"function"==typeof r&&r())}